---
title: Capstone Project- The Role of Maternal Social Deprivation on Under 5 Undernutrition
  in Northern and Southern Nigeria
author: "Nkiru Obi"
date: "10/31/2021"
output: html_document
---

```{r include=FALSE}
#Load packages
#pacman::p_load(tidyverse, table1, foreign, haven, Publish, survey, ROCR, odds.n.ends, blorr, lmtest, car)

# Read in dataset
#DHS <- read_sav("C:/Users/nkiru/Documents/NKYRUH/CAPSTONE/NGKR7BSV/NGKR7BFL.sav")
```

```{r include=FALSE}
#Select variables of interest into smaller dataframe called dhs1 and rename variables.
#dhs1 <- DHS %>%
#  select(V101, V102, V106, V136, V137, V190, V714, B4, B8, B5, B19, HW70, HW71, HW72) %>%
#  rename(region = V101, residence = V102, education = V106, hseholdno = V136, children_5 = V137, wealth_index = V190, employment = V714, sex = B4, ageyr = B8, child_alive = B5, agemonth = B19, htage = HW70, wtage = HW71, wtht = HW72)

#summary(dhs1)
```

```{r include=FALSE}
#Clean variables and rename variable labels
dhs2 <- dhs1 %>%
  mutate(region= case_when(region== 1~ 'North', 
                           region== 2~ 'North',
                           region== 3~ 'North',
                           TRUE ~ 'South')) %>%
  mutate(residence= case_when(residence== 1~ 'Urban',
                              TRUE ~ 'Rural')) %>%
  mutate(education= case_when(education== 0~ 'No education',
                              education== 1~ 'Primary',
                              education== 2~ 'Secondary',
                              TRUE ~ 'Higher education')) %>%
  mutate(wealth_index= case_when(wealth_index== 1~ 'Poorest',
                                 wealth_index== 2~ 'Poorer',
                                 wealth_index== 3~ 'Middle',
                                 wealth_index== 4~ 'Richer',
                                 TRUE ~ 'Richest')) %>%
  mutate(employment= case_when(employment== 0~ 'Not employed',
                               TRUE ~ 'Employed')) %>%
  mutate(sex= case_when(sex== 1~ 'Male',
                        TRUE ~ 'Female')) %>%
  mutate(child_alive= case_when(child_alive== 0~ 'dead',
                                child_alive== 1~ 'alive'))

dhs3 <- dhs2 %>%
  mutate(ht4age= htage/100) %>%
  mutate(wt4age= wtage/100) %>%
  mutate(wt4ht= wtht/100) 

dhs3$agemo <- ifelse(dhs3$child_alive == 'alive', dhs3$agemonth, NA)

#dhs4 <- dhs3 %>%
   #ht4age <- if_else(ht4age < -2, 1, 0) %>%
   #ht4age <- factor(ht4age, levels = c(1,0), labels = c('Stunted', 'Not stunted')) %>%
   #wt4age <- if_else(wt4age < -2, 1, 0) %>%
   #wt4age <- factor(wt4age, levels = c(1,0), labels = c('Underweight', 'Not underweight')) %>%
   #wt4ht <- if_else(wt4ht < -2, 1, 0) %>%
   #wt4ht <- factor(wt4ht, levels = c(1,0), labels = c('Wasted', 'Not wasted'))


dhs3$ht4age <- if_else(dhs3$ht4age > -2, 0, 1)
dhs3$ht4age <- factor(dhs3$ht4age, levels = c(0,1), labels = c('Not stunted', 'Stunted'))

dhs3$wt4age <- if_else(dhs3$wt4age > -2, 0, 1)
dhs3$wt4age <- factor(dhs3$wt4age, levels = c(0,1), labels = c('Not underweight', 'Underweight'))

dhs3$wt4ht <- if_else(dhs3$wt4ht > -2, 0, 1)
dhs3$wt4ht <- factor(dhs3$wt4ht, levels = c(0,1), labels = c('Not wasted', 'Wasted'))

dhs_new <- dhs3 %>%
drop_na()
summary(dhs_new)

#Check missing rate
missingRate <- 1- nrow(dhs_new)/nrow(dhs3)
missingRate

#view class of variables
sapply(dhs_new, class)
```

```{r include=FALSE}
#graphs of variables
# 1) Age
dhs_new %>%
  ggplot(aes(x = agemo)) +
  geom_bar() +
  labs(x = "age in months", y = "Observations",
       title = "Age distribution (in Months) of under 5s in Nigeria (DHS 2018)") +
  theme_minimal()

# 2) Number of household members
dhs_new %>%
  ggplot(aes(x = hseholdno, fill = hseholdno)) +
  geom_bar() +
  labs(x = "Number of household members", y = "Observations",
       title = "Number of household members (DHS 2018)") +
  theme_minimal()

# 3) Number of children <5 in household
dhs_new %>%
  ggplot(aes(x = children_5, fill = children_5)) +
  geom_bar() +
  labs(x = "Number of children <5", y = "Observations",
       title = "Number of children <5 in household (DHS 2018)") +
  theme_minimal()
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
#Table 1 to describe participants.
label(dhs_new$agemo)<-"Age of child(months)"
label(dhs_new$sex)<-"Sex of child"
label(dhs_new$residence)<-"Place of residence"
label(dhs_new$education)<-"Level of education of mother"
label(dhs_new$hseholdno)<-"Number of persons in the household"
label(dhs_new$children_5)<-"Number of children under 5 in the household"
label(dhs_new$wealth_index)<-"Household wealth index"
label(dhs_new$employment)<-"Mother's employment status"
label(dhs_new$wt4age)<-"Child's Weight for Age"
label(dhs_new$ht4age)<-"Child's Height for Age"
label(dhs_new$wt4ht)<-"Child's Weight for Height"

table1(~agemo + sex + residence + education + hseholdno + children_5 + wealth_index + employment + wt4age + ht4age + wt4ht|region, overall = "total", dhs_new,
       caption = "Table 1: Characteristics of Study Participants by Region")
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
#Underweight Status by Region
table1(~agemo + sex + residence + education + hseholdno + children_5 + wealth_index + employment|wt4age * region, overall = "total", dhs_new,
       caption = "Table 1.1: Underweight Status by Region")
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
#Stunting Status by Region
table1(~agemo + sex + residence + education + hseholdno + children_5 + wealth_index + employment|ht4age * region, overall = "total", dhs_new,
       caption = "Table 1.2: Stunting Status by Region")
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
#Wasting Status by Region
table1(~agemo + sex + residence + education + hseholdno + children_5 + wealth_index + employment|wt4ht * region, overall = "total", dhs_new,
       caption = "Table 1.3: Wasting Status by Region")
```

```{r include=FALSE}
#check levels
levels(dhs_new$wt4age)
levels(dhs_new$ht4age)
levels(dhs_new$wt4ht)

#Relevel variables
#dhs_new$wt4age <- relevel(dhs_new$wt4age, ref = "Underweight")
#dhs_new$ht4age <- relevel(dhs_new$ht4age, ref = "Stunted")
#dhs_new$wt4ht <- relevel(dhs_new$wt4ht, ref = "Wasted")
dhs_new$region <- relevel(as.factor(dhs_new$region), ref = "South")
dhs_new$residence <- relevel(as.factor(dhs_new$residence), ref = "Urban")
dhs_new$education <- relevel(as.factor(dhs_new$education), ref = "Higher education")
dhs_new$wealth_index <- relevel(as.factor(dhs_new$wealth_index), ref = "Richest")
dhs_new$employment <- as.factor(dhs_new$employment)
dhs_new$sex <- as.factor(dhs_new$sex)
```

\#\#UNDERWEIGHT

```{r include=FALSE}
#logistic model with underweight as outcome
underweightModel <- glm(wt4age ~ region + residence + education + wealth_index + employment, data= dhs_new, family="binomial")
summary(underweightModel)

odds.n.ends(underweightModel)
```

```{r include=FALSE}
#logistic model with underweight as outcome and age & sex as confounders
fullUnderweightModel <- glm(wt4age ~ region + residence + education + wealth_index + employment + agemo + sex, data= dhs_new, family="binomial")
summary(fullUnderweightModel)

odds.n.ends(fullUnderweightModel)
```

### Full model vs. reduced model

```{r include=FALSE}
#likelihood ratio test: compare two nested models
lrtest(underweightModel, fullUnderweightModel)
```

The absolute values of log likelihood of the model with confounders (-5592.4) is larger than the reduced model (-5598.3). Based on the significant p value from LR test, the model with confounders is better than the reduced model.

### Assumption Check

*Independence of observations* The survey uses a two-stage probability sampling method to select households for data collection. There is one record for every child between 0 - 59 months of interviewed women. One woman may have multiple children in the data set and so, It is likely that observations may not be completely independent.

*Linearity*

```{r include=FALSE}
#linearity
dhs_new <- dhs_new %>%
  mutate(agemo.logAgemo = agemo * log(agemo)) #create term to test linearity

boxTidwellAge <- glm(wt4age ~ region + residence + education + wealth_index + employment + agemo + agemo.logAgemo + sex, data= dhs_new, family="binomial") 

summary(boxTidwellAge)
```

The interaction term has a significant p value (p \< 1.5e-09) indicating that the linearity assumption is violated.

```{r include=FALSE}
#Transform the age variable to age categories
dhsAgeRec <- dhs_new %>%
  mutate(age_cat= as.factor(case_when(agemo < 24 ~ "less than 2 years",
                                      agemo >= 24 ~ "2 to 5 years")))

table(dhsAgeRec$age_cat)

#Rerun model
underweightCatMod <- glm(wt4age ~ region + residence + education + wealth_index + employment + age_cat + sex, data= dhsAgeRec, family="binomial") 

summary(underweightCatMod)
odds.n.ends(underweightCatMod)
```

+---------------+------------+-------------+---------+
| Predictor     | Odds Ratio | 95% CI      | P-value |
+===============+============+=============+=========+
| Region:       | 1.38       | 1.21 - 1.57 | \< 0.05 |
|               |            |             |         |
| North         |            |             |         |
+---------------+------------+-------------+---------+
| Residence:    | 1.05       | 0.93 - 1.18 | 0.44    |
|               |            |             |         |
| Rural         |            |             |         |
+---------------+------------+-------------+---------+
| Education:    | 2.81       | 2.18 - 3.66 | \< 0.05 |
|               |            |             |         |
| No Education  | 1.55       | 1.19 - 2.04 | \< 0.05 |
|               |            |             |         |
| Primary       | 1.33       | 1.04 - 1.70 | \< 0.05 |
|               |            |             |         |
| Secondary     |            |             |         |
+---------------+------------+-------------+---------+
| Wealth Index: | 2.09       | 1.68 - 2.62 | \< 0.05 |
|               |            |             |         |
| Poorest       | 1.70       | 1.37 - 2.10 | \< 0.05 |
|               |            |             |         |
| Poorer        | 1.51       | 1.24 - 1.86 | \< 0.05 |
|               |            |             |         |
| Middle        | 1.19       | 0.98 - 1.46 | 0.08    |
|               |            |             |         |
| Richer        |            |             |         |
+---------------+------------+-------------+---------+
| Employment:   | 1.11       | 1.00 - 1.23 | \< 0.05 |
|               |            |             |         |
| Not Employed  |            |             |         |
+---------------+------------+-------------+---------+

: Table 2.1 : Associations of Maternal Social Deprivation With Underweight[^1]

[^1]: \*Model adjusted for age and sex of child.

*Multicollinearity*

```{r include=FALSE}
#Variance Inflation Factors
vif(underweightCatMod)
vif(underweightModel)
```

VIF are all less than 2 indicating that there is no multicollinearity between the variables.

*Influence*

```{r include=FALSE}
#influence plot - Cook's D plot-identifies observation number in parent dataset
plot(underweightCatMod, which=4, id.n=5, col="red")
plot(underweightModel, which=4, id.n=5, col="red")
```

```{r include=FALSE}
#Hosmer lemeshow goodness of fit test for reduced model
blr_test_hosmer_lemeshow(underweightCatMod)
blr_test_hosmer_lemeshow(fullUnderweightModel)
blr_test_hosmer_lemeshow(underweightModel)
```

The Hosmer & lemeshow goodness of fit test for the model without confounders has a non-significant p-value (0.4605) indicating that this model is a good fit. This model also meets all the assumptions of the logistic regression model. The model with confounders does not meet linearity assumption and is not a good fit (p = 0.0158). While the model with age categories meets all assumptions, it is shown to not be a good fit (p = 0.0134).

\#\#STUNTING

```{r include=FALSE}
#logistic model with stunting as outcome
stuntingModel <- glm(ht4age ~ region + residence + education + wealth_index + employment, data= dhs_new, family="binomial")
summary(stuntingModel)

odds.n.ends(stuntingModel)
```

```{r include=FALSE}
#logistic model with stunting as outcome and age & sex as confounders
fullStuntingModel <- glm(ht4age ~ region + residence + education + wealth_index + employment + agemo + sex, data= dhs_new, family="binomial")
summary(fullStuntingModel)

odds.n.ends(fullStuntingModel)
```

\#\#\#Full model vs Reduced model

```{r include=FALSE}
#likelihood ratio test: compare two nested models
lrtest(stuntingModel, fullStuntingModel)
```

The absolute values of log likelihood of the model with confounders (-6724.7) is larger than the reduced model (-6814.6). Based on the significant p value from LR test, the model with confounders is better than the reduced model.

\#\#\#Assumption Check

```{r include=FALSE}
#linearity
dhs_new <- dhs_new %>%
  mutate(agemo.logAgemo = agemo * log(agemo)) #create term to test linearity

boxTidwellAge2 <- glm(ht4age ~ region + residence + education + wealth_index + employment + agemo + agemo.logAgemo + sex, data= dhs_new, family="binomial") 

summary(boxTidwellAge2)
```

The interaction term has a significant p value (p \< 2e-16) indicating that the linearity assumption is violated.

```{r include=FALSE}
#Rerun model with age categories
stuntingCatMod <- glm(ht4age ~ region + residence + education + wealth_index + employment + age_cat + sex, data= dhsAgeRec, family="binomial") 

summary(stuntingCatMod)
odds.n.ends(stuntingCatMod)
```

+---------------+------------+-------------+---------+
| [^2]Predictor | Odds Ratio | 95% CI      | P-value |
+===============+============+=============+=========+
| Region:       | 1.66       | 1.49 - 1.85 | \< 0.05 |
|               |            |             |         |
| North         |            |             |         |
+---------------+------------+-------------+---------+
| Residence:    | 1.02       | 0.92 - 1.12 | 0.75    |
|               |            |             |         |
| Rural         |            |             |         |
+---------------+------------+-------------+---------+
| Education:    | 3.20       | 2.58 - 4.00 | \< 0.05 |
|               |            |             |         |
| No Education  | 2.31       | 1.85 - 2.89 | \< 0.05 |
|               |            |             |         |
| Primary       | 1.64       | 1.34 - 2.02 | \< 0.05 |
|               |            |             |         |
| Secondary     |            |             |         |
+---------------+------------+-------------+---------+
| Wealth Index: | 2.46       | 2.03 - 2.97 | \< 0.05 |
|               |            |             |         |
| Poorest       | 2.17       | 1.81 - 2.60 | \< 0.05 |
|               |            |             |         |
| Poorer        | 1.83       | 1.55 - 2.16 | \< 0.05 |
|               |            |             |         |
| Middle        | 1.32       | 1.12 - 1.56 | \< 0.05 |
|               |            |             |         |
| Richer        |            |             |         |
+---------------+------------+-------------+---------+
| Employment:   | 1.02       | 0.93 - 1.11 | 0.74    |
|               |            |             |         |
| Not Employed  |            |             |         |
+---------------+------------+-------------+---------+

: Table 2.2- Associations of Maternal Social Deprivation With Stunting.

[^2]: \*Model adjusted for age and sex of child.

*Multicollinearity*

```{r include=FALSE}
#Variance Inflation Factors
vif(stuntingModel)
vif(fullStuntingModel)
vif(stuntingCatMod)
```

there is no multicollinearity between the variables.

*Influence*

```{r include=FALSE}
#influence plot - Cook's D plot-identifies observation number in parent dataset
plot(stuntingModel, which=4, id.n=5, col="red")
plot(fullStuntingModel, which=4, id.n=5, col="red")
plot(stuntingCatMod, which=4, id.n=5, col="red")
```

```{r include=FALSE}
#Hosmer lemeshow goodness of fit test for full model
blr_test_hosmer_lemeshow(fullStuntingModel)
```

The Hosmer & lemeshow goodness of fit test has a significant p-value (0.0000) indicating that this model is not a good fit.

```{r include=FALSE}
blr_test_hosmer_lemeshow(stuntingModel)

blr_test_hosmer_lemeshow(stuntingCatMod)
```

The Hosmer & lemeshow goodness of fit test for the stunting model has a non-significant p-value (0.599) indicating that this model is a good fit. The Hosmer & lemeshow goodness of fit test for the stuntingCatmod has a significant p-value (6e-04) indicating that this model is not a good fit.

\#\#Wasting

```{r include=FALSE}
#logistic model with wasting as outcome
wastingModel <- glm(wt4ht ~ region + residence + education + wealth_index + employment, data= dhs_new, family="binomial")
summary(wastingModel)

odds.n.ends(wastingModel)
```

```{r include=FALSE}
#logistic model with stunting as outcome and age & sex as confounders
fullWastingModel <- glm(wt4ht ~ region + residence + education + wealth_index + employment + agemo + sex, data= dhs_new, family="binomial")
summary(fullWastingModel)

odds.n.ends(fullWastingModel)
```

\#\#\#Full model vs Reduced model

```{r include=FALSE}
#likelihood ratio test: compare two nested models
lrtest(wastingModel, fullWastingModel)
```

The absolute values of log likelihood of the model with confounders (-2693.8) is larger than the reduced model (-2782.6). Based on the significant p value from LR test, the model with confounders is better than the reduced model.

\#\#\#Assumption Check

```{r include=FALSE}
# Linearity
boxTidwellAge3 <- glm(wt4ht ~ region + residence + education + wealth_index + employment + agemo + agemo.logAgemo + sex, data= dhs_new, family="binomial") 

summary(boxTidwellAge3)
```

The interaction term has a significant p value (p = 0.00311) indicating that the linearity assumption is violated.

```{r include=FALSE}
#Rerun model with age categories
wastingCatMod <- glm(wt4ht ~ region + residence + education + wealth_index + employment + age_cat + sex, data= dhsAgeRec, family="binomial") 

summary(wastingCatMod)
odds.n.ends(wastingCatMod)
```

+---------------+------------+-------------+---------+
| Predictor     | Odds Ratio | 95% CI      | P-value |
+===============+============+=============+=========+
| Region:       | 1.30       | 1.06 - 1.61 |         |
|               |            |             |         |
| North         |            |             |         |
+---------------+------------+-------------+---------+
| Residence:    | 1.05       | 0.86 - 1.27 |         |
|               |            |             |         |
| Rural         |            |             |         |
+---------------+------------+-------------+---------+
| Education:    | 1.53       | 1.05 - 2.26 |         |
|               |            |             |         |
| No Education  | 0.95       | 0.64 - 1.43 |         |
|               |            |             |         |
| Primary       | 1.02       | 0.72 - 1.47 |         |
|               |            |             |         |
| Secondary     |            |             |         |
+---------------+------------+-------------+---------+
| Wealth Index: | 1.76       | 1.24 - 2.51 |         |
|               |            |             |         |
| Poorest       | 1.33       | 0.95 - 1.89 |         |
|               |            |             |         |
| Poorer        | 1.37       | 1.00 - 1.90 |         |
|               |            |             |         |
| Middle        | 1.17       | 0.86 - 1.59 |         |
|               |            |             |         |
| Richer        |            |             |         |
+---------------+------------+-------------+---------+
| Employment:   | 0.91       | 0.77 - 1.07 |         |
|               |            |             |         |
| Not Employed  |            |             |         |
+---------------+------------+-------------+---------+

: Table 2.3: Associations of Maternal Social Deprivation With Wasting[^3]

[^3]: Model adjusted for age and sex of child.

\# *Multicollinearity*

```{r include=FALSE}
#Variance Inflation Factors
vif(wastingModel)
vif(fullWastingModel)
vif(wastingCatMod)
```

There is no multicollinearity between the variables.

```{r include=FALSE}
#Influence
#influence plot - Cook's D plot-identifies observation number in parent dataset
plot(wastingModel, which=4, id.n=5, col="green")
plot(fullWastingModel, which=4, id.n=5, col="green")
plot(wastingCatMod, which=4, id.n=5, col="green")
```

```{r include=FALSE}
#Hosmer lemeshow goodness of fit test for full model
blr_test_hosmer_lemeshow(wastingModel)
blr_test_hosmer_lemeshow(fullWastingModel)
blr_test_hosmer_lemeshow(wastingCatMod)
```

The Hosmer & lemeshow goodness of fit test for all 3 models have non-significant p-values indicating that these models are good fits. I will be using the wasting model and the wastingCatmod.
